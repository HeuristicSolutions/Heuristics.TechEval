@model Heuristics.TechEval.Web.Models.MembersViewModel

@{
    ViewBag.Title = "Members";
}

<style>
    .modal-add .modal-title:after {
        content: "Add Member";
    }

    .modal-edit .modal-title:after {
        content: "Edit Member";
    }

    .not-valid [required] {
        border: red 1px solid !important;
    }

    .not-valid label:after {
        content: "Required";
        color: red;
        margin-left: 5px;
        display: inline-block;
        font-weight: normal;
    }

    .modal-header .close {
        position: fixed;
        right: 10px;
        top: 15px;
    }
</style>

<h1>Member List</h1>

<button type="button" class="btn btn-primary pull-right btn-add-member">Add Member</button>
<table class="table table-striped table-bordered table-hover" id="members-list">
    <thead>
        <tr>
            <th scope="col">#</th>
            <th scope="col">Name</th>
            <th scope="col">Email</th>
            <th scope="col">Category</th>
            <th scope="col"></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var member in Model.Members)
        {
            <tr class="member-detail" data-id="@member.Id">
                <td class="member-id" scope="row">@member.Id</td>
                <td class="member-name">@member.Name</td>
                <td class="member-email">@member.Email</td>
                <td class="member-category" data-id="@member.CategoryId">@member.CategoryName</td>
                <td>
                    <button type="button" class="btn btn-primary btn-edit-member">Edit</button>
                </td>
            </tr>
        }
    </tbody>
</table>

<div class="modal fade" id="MemberModal">
    <div class="modal-dialog" role="document">
        <form id="MemberForm" action="/Members" method="post">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="Name">Member Name</label>
                        <input type="text" class="form-control" id="Name" name="Name" placeholder="John Smith" required />
                    </div>
                    <div class="form-group">
                        <label for="Email">Email Address</label>
                        <input type="email" class="form-control" id="Email" name="Email" placeholder="you@awesome.com" required />
                    </div>
                    <div class="form-group">
                        <label for="Category">Category</label>
                        <select class="form-control" style="display:block;" id="CategoryId" name="CategoryId">
                            @foreach (var category in Model.Categories) { 
                                <option value="@category.Id" >@category.Name</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="submit" class="btn btn-primary" id="btnSaveMember" value="Save" />
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="ErrorModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Required Fields</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <ul id="val-errors"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>



<script type="text/javascript">

    function getModal()
    {
        return $('#MemberModal');
    }
    function getErrorModal() {
        return $('#ErrorModal');
    }

    var _listColumnId = 0;
    var _listColumnName = 1;
    var _listColumnEmail = 2;
    var _listColumnCategory = 3;

    $(document).ready(function () {
        getModal().ajaxForm({
            success: function (formData, jqForm, options) {

                //TODO: check if object or empty
                let id = parseInt(formData.id);
                var row = $('#members-list').find('.member-detail[data-id=' + id + ']');

                if (row.length > 0) {
                    row.find('td').eq(_listColumnName).html(formData.name)
                    row.find('td').eq(_listColumnEmail).html(formData.email)
                    row.find('td').eq(_listColumnCategory).html(formData.categoryName)
                } else {
                    var clone = $('#members-list .member-detail:last').clone();

                    clone.attr('data-id', id);
                    clone.find('td').eq(_listColumnId).html(formData.id);
                    clone.find('td').eq(_listColumnName).html(formData.name);
                    clone.find('td').eq(_listColumnEmail).html(formData.email);
                    clone.find('td').eq(_listColumnCategory).attr('data-id', formData.categoryId).html(formData.categoryName);
                    clone.appendTo('#members-list tbody');
                }

                getModal().modal('hide');
            },
            error: function (formData, jqForm) {
                var errors = formData.responseJSON;

                if (errors.length > 0) {
                    for (var i = 0; i < errors.length; i++) {
                        getErrorModal().find('#val-errors').html('<li>' + errors[i] + '</li>');
                    }

                    getErrorModal().modal('show');
                }

            }
        });

        $('.btn-add-member').on('click', function () {
            document.getElementById('MemberForm').setAttribute('action', '/Members/New');
            getModal().addClass('modal-add').modal('show');
        });

        $('#members-list').on('click', '.btn-edit-member', function () {

            let modal = getModal();
            var member = $(this).parents('.member-detail')[0];

            let id = parseInt($(member).find('.member-id').html());
            $(modal).find('#Name').val($(member).find('.member-name').html());
            $(modal).find('#Email').val($(member).find('.member-email').html());
            $(modal).find('#CategoryId').val($(member).find('.member-category').attr('data-id'));

            document.getElementById('MemberForm').setAttribute('action', '/Members/Edit/' + id);

            $(modal).addClass('modal-edit').modal('show');
        });


        $('#btnSaveMember').on('click', function (e) {
            let errorsFound = 0;

            getModal().find('input[required]').each(function (i, el) {
                if (this.value.trim().length == 0) {
                    $(this).parent().addClass('not-valid');
                    errorsFound++;
                }
            });

            if (errorsFound > 0) {
                e.preventDefault();
            }
        })

        getModal().on('hidden.bs.modal', function (e) {
            $(this).find('#Name, #Email').val('');
            $(this).find('.not-valid').removeClass('not-valid');
        });

    });
</script>